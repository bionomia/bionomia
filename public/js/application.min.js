Array.prototype.all_unique=function(){return this.filter(function(a,b,c){return c.indexOf(a)===b})},jQuery.fn.preventDoubleSubmission=function(){return $(this).on("submit",function(b){var a=$(this);!0===a.data("submitted")?b.preventDefault():a.data("submitted",!0)}),this};var Application=function($,a){"use strict";var b={user_id:"",path:"",method:"POST",identifier:"",spinner:'<div class="spinner-grow" role="status"><span class="sr-only">Loading...</span></div>',data_sources:{agent:{},user:{},organization:{}},init:function(a,b,c,d){this.user_id=void 0!==a?a:"",this.method=void 0!==b?b:"POST",this.path=void 0!==c?c:"",this.identifier=void 0!==d?d:"",this.ajax_setup(),this.profile_cards(),this.bloodhound(),this.typeahead(),this.tooltips(),this.activate_dropdowns(),this.activate_radios(),this.activate_switch(),this.activate_refresh(),this.activate_popovers(),this.candidate_counter(),this.helper_navbar(),this.helper_modal()},ajax_setup:function(){var b=[];$.ajaxSetup({headers:{"X-CSRF-Token":$('meta[name="csrf-token"]').attr("content")}}),$(a).bind("beforeunload",function(a){$.each(b,function(b,a){a&&a.abort()})}),$(document).ajaxSend(function(c,a,d){b.push(a)}),$(document).ajaxComplete(function(d,a,e){var c=$.inArray(a,b);b.splice(c,1)})},profile_cards:function(){$(".card-profile").on("click",function(b){b.stopPropagation(),a.location=$(this).find(".card-header a").attr("href")})},bloodhound:function(){this.data_sources.agent=this.create_bloodhound("agent"),this.data_sources.agent.initialize(),this.data_sources.user=this.create_bloodhound("user"),this.data_sources.user.initialize(),this.data_sources.organization=this.create_bloodhound("organization"),this.data_sources.organization.initialize(),this.data_sources.dataset=this.create_bloodhound("dataset"),this.data_sources.dataset.initialize(),this.data_sources.taxon=this.create_bloodhound("taxon"),this.data_sources.taxon.initialize()},create_bloodhound:function(a){return new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,sufficient:10,remote:{url:"/"+a+".json?q=%QUERY",wildcard:"%QUERY",rateLimitWait:500,transform:function(b){return $.map(b,function(b){return b.type=a,b})}}})},typeahead:function(){var d=this,b="undefined"!=typeof Handlebars&&$("#result-template").length>0?Handlebars.compile($("#result-template").html()):"",c="undefined"!=typeof Handlebars&&$("#empty-template").length>0?Handlebars.compile($("#empty-template").html()):"";$("#typeahead-agent").typeahead({minLength:3,highlight:!0},{name:"agent",limit:10,source:this.data_sources.agent.ttAdapter(),display:"fullname_reverse"}).on("typeahead:select",function(g,b){var c="undefined"!=typeof Filters?Filters.datasetKey:"",e="undefined"!=typeof Filters?Filters.taxon_id:"",f="undefined"!=typeof Filters?Filters.kingdom:"";"/admin"===d.path?a.location.href="/admin/user/"+d.identifier+"/advanced-search?agent_id="+b.id+"&datasetKey="+c+"&taxon_id="+e+"&kingdom="+f:"/agents"===d.path?a.location.href="/agent/"+b.id:"/help-others"===d.path?a.location.href="/help-others/"+d.identifier+"/advanced-search?agent_id="+b.id+"&datasetKey="+c+"&taxon_id="+e+"&kingdom="+f:a.location.href="/profile/advanced-search?agent_id="+b.id+"&datasetKey="+c+"&taxon_id="+e+"&kingdom="+f}),$("#typeahead-user").typeahead({minLength:3,highlight:!0},{name:"user",limit:10,source:this.data_sources.user.ttAdapter(),display:"fullname_reverse",templates:{suggestion:b,empty:c}}).on("typeahead:select",function(e,c){var b=c.orcid||c.wikidata;"/admin"===d.path?a.location.href="/admin/user/"+b:"/roster"===d.path?a.location.href="/"+b:a.location.href="/help-others/"+b}),$("#typeahead-organization").typeahead({minLength:1,highlight:!0},{name:"organization",source:this.data_sources.organization.ttAdapter(),display:"name"}).on("typeahead:select",function(c,b){"/admin"===d.path?a.location.href="/admin/organization/"+b.id:a.location.href="/organization/"+b.preferred}),$("#typeahead-dataset").typeahead({minLength:1,highlight:!0},{name:"dataset",limit:10,source:this.data_sources.dataset.ttAdapter(),display:"title"}).on("typeahead:select",function(g,b){var c="undefined"!=typeof Filters?Filters.agent_id:"",e="undefined"!=typeof Filters?Filters.taxon_id:"",f="undefined"!=typeof Filters?Filters.kingdom:"";"/admin"!==d.path||d.identifier?"/admin"===d.path&&d.identifier?a.location.href="/admin/user/"+d.identifier+"/advanced-search?agent_id="+c+"&datasetKey="+b.datasetkey+"&taxon_id="+e+"&kingdom="+f:"/help-others"===d.path?a.location.href="/help-others/"+d.identifier+"/advanced-search?agent_id="+c+"&datasetKey="+b.datasetkey+"&taxon_id="+e+"&kingdom="+f:"/profile"===d.path?a.location.href="/profile/advanced-search?agent_id="+c+"&datasetKey="+b.datasetkey+"&taxon_id="+e+"&kingdom="+f:a.location.href="/dataset/"+b.datasetkey:a.location.href="/admin/dataset/"+b.datasetkey}),$("#typeahead-taxon").typeahead({minLength:1,highlight:!0},{name:"taxon",limit:10,source:this.data_sources.taxon.ttAdapter(),display:"name"}).on("typeahead:select",function(g,b){var c="undefined"!=typeof Filters?Filters.agent_id:"",e="undefined"!=typeof Filters?Filters.datasetKey:"",f="undefined"!=typeof Filters?Filters.kingdom:"";"/help-others"===d.path?a.location.href="/help-others/"+d.identifier+"/advanced-search?agent_id="+c+"&datasetKey="+e+"&taxon_id="+b.id+"&kingdom="+f:"/profile"===d.path?a.location.href="/profile/advanced-search?agent_id="+c+"&datasetKey="+e+"&taxon_id="+b.id+"&kingdom="+f:"/admin"!==d.path||d.identifier?"/admin"===d.path&&d.identifier?a.location.href="/admin/user/"+d.identifier+"/advanced-search?agent_id="+c+"&datasetKey="+e+"&taxon_id="+b.id+"&kingdom="+f:"/taxa"===d.path?a.location.href="/taxon/"+b.name:a.location.href=a.location.pathname+"?q="+b.name:a.location.href="/admin/taxon/"+b.name})},tooltips:function(){$('[data-toggle="tooltip"]').tooltip(),$('[data-toggle="tooltip"]',"nav").on("mouseenter",function(){$(this).find("span").is(":visible")&&$(this).tooltip("hide")}).on("focus",function(){$(this).tooltip("hide")})},activate_dropdowns:function(){var b=this,c="",d="",e="",f="",g="";$("a.expand-collapse").on("click",function(b){var a=$(this).children().first();b.stopPropagation(),b.preventDefault(),a.hasClass("fa-angle-double-down")?(a.removeClass("fa-angle-double-down").addClass("fa-angle-double-up"),$(this).parent().prev().css({"max-height":"100%"})):(a.removeClass("fa-angle-double-up").addClass("fa-angle-double-down"),$(this).parent().prev().css({"max-height":"300px"}))}),$("#kingdom, #country").on("change",function(){"undefined"!=typeof Filters&&(c=Filters.agent_id,d=Filters.datasetKey,e=Filters.taxon_id,f=Filters.kingdom,g=Filters.country_code),"country"==this.id&&(g=this.value),"kingdom"==this.id&&(f=this.value),"/help-others"===b.path?a.location.href="/help-others/"+b.identifier+"/advanced-search?agent_id="+c+"&taxon_id="+e+"&datasetKey="+d+"&kingdom="+f+"&country_code="+g:"/profile"===b.path?a.location.href="/profile/advanced-search?agent_id="+c+"&datasetKey="+d+"&taxon_id="+e+"&kingdom="+f+"&country_code="+g:"/admin"===b.path&&(a.location.href="/admin/user/"+b.identifier+"/advanced-search?agent_id="+c+"&datasetKey="+d+"&taxon_id="+e+"&kingdom="+f+"&country_code="+g)})},activate_switch:function(){$("#toggle-public").on("change",function(){return $.ajax({method:"PUT",url:$(this).attr("data-url"),dataType:"json",data:JSON.stringify({is_public:$(this).prop("checked")})}).done(function(a){location.reload()}),!1})},activate_radios:function(){var b=this,d="",c="";"/profile"===b.path?d=b.path+"/candidates":"/admin"===b.path?(c=a.location.pathname.split("/")[3],d=b.path+"/user/"+c+"/candidates"):"/help-others"===b.path&&(c=a.location.pathname.split("/")[2],d=b.path+"/"+c),$("#relaxed").on("change",function(){return d=new URL(a.location.href),$(this).prop("checked")?(d.searchParams.set("relaxed",1),a.location.href=d.href):(d.searchParams.set("relaxed",0),a.location.href=d.href),!1}),$("input.action-radio").on("change",function(){var e=$(this).parents("tr"),a=$(this).attr("data-action"),f=$(this).parent(),g=$(this);if("selection-all"===$(this).attr("name")){var c=$.map($("[data-occurrence-id]:not(:disabled)"),function(a){return $(a).attr("data-occurrence-id")}).all_unique().toString();if(!c.trim())return!1;$.ajax({method:b.method,url:b.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:b.user_id,occurrence_ids:c,action:a,visible:!0}),beforeSend:function(a){$(".table label:not(:disabled)").addClass("disabled"),$(".table button:not(:disabled)").addClass("disabled")}}).done(function(c){"POST"===b.method||g.hasClass("restore-ignored")?$(".table tbody tr").fadeOut(250).promise().done(function(){$(this).remove(),$(".table tbody").append('<tr><td colspan="12">'+b.spinner+"</td></tr>"),location.reload()}):($(".table button").removeClass("disabled"),$("label").each(function(){var b=$(this).hasClass("active");$(this).removeClass("active").removeClass("disabled"),$("input:first-child:not(:disabled)",this).attr("data-action")===a&&$(this).addClass("active"),$("input:first-child",this).prop("disabled")&&($(this).addClass("disabled"),b&&$(this).addClass("active"))}))})}else{var d=$(this).attr("data-occurrence-id");$.ajax({method:b.method,url:b.path+"/user-occurrence/"+d+".json",dataType:"json",data:JSON.stringify({user_id:b.user_id,action:a,visible:!0}),beforeSend:function(a){$("label",e).addClass("disabled"),$("button",e).addClass("disabled")}}).done(function(a){"POST"===b.method||g.hasClass("restore-ignored")?g.parents("tr").fadeOut(250).promise().done(function(){$(this).remove(),$("input.action-radio").length<=6&&($(".table tbody").append('<tr><td colspan="12">'+b.spinner+"</td></tr>"),location.reload())}):($("label",e).removeClass("active").removeClass("disabled"),f.addClass("active"),$("button",e).removeClass("disabled"))})}return!1}),$("button.remove:not(:disabled)").on("click",function(){var a=$(this).attr("data-occurrence-id"),c=$(this).parents("tr");return $.ajax({method:"DELETE",url:b.path+"/user-occurrence/"+a+".json",data:JSON.stringify({user_id:b.user_id}),beforeSend:function(a){$("label",c).addClass("disabled"),$("button",c).addClass("disabled")}}).done(function(a){c.fadeOut(250,function(){c.remove(),0===$("button.remove:not(:disabled)").length&&location.reload()})}),!1}),$("button.remove-all").on("click",function(){var a=$.map($("[data-occurrence-id]:not(:disabled)"),function(a){return $(a).attr("data-occurrence-id")}).all_unique().toString();return!!a.trim()&&($.ajax({method:"DELETE",url:b.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:b.user_id,occurrence_ids:a}),beforeSend:function(a){$(".table label").addClass("disabled"),$(".table button").addClass("disabled")}}).done(function(a){$(".table tbody tr").fadeOut(250).promise().done(function(){$(this).remove(),$(".table tbody").append('<tr><td colspan="12">'+b.spinner+"</td></tr>"),location.reload()})}),!1)}),$("button.hide-all").on("click",function(){var a=$.map($("[data-occurrence-id]:not(:disabled)"),function(a){return $(a).attr("data-occurrence-id")}).all_unique().toString();return!!a.trim()&&($.ajax({method:b.method,url:b.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:b.user_id,occurrence_ids:a,visible:0}),beforeSend:function(a){$(".table label").addClass("disabled"),$(".table button").addClass("disabled")}}).done(function(a){$(".table tbody tr").fadeOut(250).promise().done(function(){$(this).remove(),$(".table tbody").append('<tr><td colspan="12">'+b.spinner+"</td></tr>"),location.reload()})}),!1)}),$("button.hide:not(:disabled)").on("click",function(){var a=$(this).attr("data-occurrence-id"),c=$(this).parents("tr");return $.ajax({method:b.method,url:b.path+"/user-occurrence/"+a+".json",dataType:"json",data:JSON.stringify({user_id:b.user_id,visible:0}),beforeSend:function(a){$("label",c).addClass("disabled"),$("button",c).addClass("disabled")}}).done(function(a){c.fadeOut(250,function(){c.remove(),0===$("button.hide:not(:disabled)").length&&location.reload()})}),!1}),$("button.thanks").on("click",function(a){a.stopPropagation();var d=this,c=$(this).attr("data-recipient-identifier");$.ajax({method:"POST",url:b.path+"/message.json",dataType:"json",data:JSON.stringify({recipient_identifier:c})}).done(function(a){$(d).removeClass("btn-outline-danger").addClass("btn-outline-success").addClass("disabled").prop("disabled",!0).find("i").removeClass("fa-heart").addClass("fa-check")})})},activate_refresh:function(){$("a.profile-flush").on("click",function(a){var b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:$(this).attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){b.find("i").first().removeClass("fa-spin"),$("#flush-message").alert().show(),$("#flush-message").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),$("a.organization-refresh").on("click",function(a){var b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:b.attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){b.find("i").first().removeClass("fa-spin"),$(".alert").alert().show(),$(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),$("a.dataset-refresh").on("click",function(a){var b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:b.attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){b.find("i").first().removeClass("fa-spin"),$(".alert-gbif").alert().show(),$(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),$("a.dataset-frictionless").on("click",function(a){var b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:b.attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){b.find("i").first().removeClass("fa-spin"),$(".alert-frictionless").alert().show(),$(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),$("#articles-check").on("click",function(a){var b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:b.attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){location.reload()}),!1}),$("a.article-process").on("click",function(a){var b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:b.attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){b.find("i").first().removeClass("fa-spin"),$(".alert-article-process").alert().show(),$(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),$("a.taxon-process").on("click",function(a){var b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:b.attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){b.find("i").first().removeClass("fa-spin"),null==a&&($("#taxon-search-result").html("No image found."),$(".alert-taxon-process").removeClass("alert-success").addClass("alert-warning")),$(".alert-taxon-process").alert().show(),$(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),$("a.help-refresh").on("click",function(a){var c,b=$(this);return a.stopPropagation(),a.preventDefault(),$.ajax({method:"GET",url:b.attr("href"),beforeSend:function(a){b.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(a){b.find("i").first().removeClass("fa-spin"),c=$.map(a,function(a){return'<a href="/help-others/'+a.identifier+'">'+a.fullname+"</a>"}),$("#friends").html(c.join(", "))}),!1})},activate_popovers:function(){var a=this;$.each($('[data-toggle="popover"]'),function(c,d){var b=this;$(this).popover({container:$(b),trigger:"hover",html:!0,content:function(){return a.gbif_images($(b))}}).on("hide.bs.popover",function(){if($(".popover:hover",b).length)return!1})})},gbif_images:function(a){var b=this;return $.ajax({url:"/occurrence/"+$(a).attr("data-gbifid")+"/still_images.json",method:"GET",dataType:"json"}).done(function(c){$(a).find(".popover-body").html(b.carousel_template(c,$(a).attr("data-gbifid"))).find("img").each(function(){var a=$(this);b.wait_loader(a[0]).then(function(){a[0].naturalHeight>300&&a.mlens({imgSrc:a.attr("data-big"),lensShape:"square",lensSize:["100px","100px"],borderSize:0,zoomLevel:1})})})}),b.spinner},wait_loader:function(a){return new Promise(function(b){a.onload=b})},carousel_template:function(b,c){var a="";return a+='<div id="carousel-indicators-'+c+'" class="carousel slide" data-ride="carousel" style="min-width:250px;min-height:100px;">',b.length>1&&(a+='<ol class="carousel-indicators">',$.each(b,function(b,d){a+='<li data-target="#carousel-indicators-'+c+'" data-slide-to="'+b+'"'+(0===b?" class='active'":"")+"></li>"}),a+="</ol>"),a+='<div class="carousel-inner">',$.each(b,function(c,b){a+='<div class="carousel-item'+(0===c?" active":"")+'">',a+='<a href="'+b.original+'" target="_blank"><img src="'+b.small+'" class="d-block" data-big="'+b.large+'"/></a>',a+="</div>"}),a+="</div>",b.length>1&&(a+='<a class="carousel-control-prev" href="#carousel-indicators-'+c+'" role="button" data-slide="prev">',a+='<span class="carousel-control-prev-icon" aria-hidden="true"></span>',a+='<span class="sr-only">Previous</span>',a+="</a>",a+='<a class="carousel-control-next" href="#carousel-indicators-'+c+'" role="button" data-slide="next">',a+='<span class="carousel-control-next-icon" aria-hidden="true"></span>',a+='<span class="sr-only">Next</span>',a+="</a>"),a+="</div>"},candidate_counter:function(){var a="";"/profile"===this.path?a=this.path:"/admin"===this.path&&this.identifier?a=this.path+"/user/"+this.identifier:"/help-others"===this.path&&this.identifier&&(a=this.path+"/"+this.identifier),a.length>0&&$("#specimen-counter").length&&$.ajax({method:"GET",url:a+"/candidate-count.json"}).done(function(a){a.count>0&&a.count<=50?$("#specimen-counter").text(a.count).show():a.count>50&&$("#specimen-counter").text("50+").show()})},helper_navbar:function(){if($("#helper-info").length&&$("#helper-navbar").length&&("/help-others"===this.path||"/admin"===this.path)){var a=$("#helper-navbar");$(document).scroll(function(){$(this).scrollTop()>$("#helper-info").offset().top?a.removeClass("d-none"):a.addClass("d-none")})}},helper_modal:function(){var a=this,b="";$("#helperPublicModal").on("show.bs.modal",function(d){var c=$("#helpers-list").hide().next();$("#helpers-list-none").hide(),c.empty(),$("#visibility-form").preventDoubleSubmission().submit(function(){$(this).find("button[type='submit']").prop("disabled",!0)}),$.ajax({method:"GET",url:"/help-others/"+a.identifier+"/helpers.json"}).done(function(a){a.helpers.length>0?(b=$.map(a.helpers,function(a){var b="";return a.email&&a.email.length>0&&(b=" ("+a.email+")"),"<li>"+a.given+" "+a.family+b+"</li>"}),c.append(b.join("")).prev().show()):$("#helpers-list-none").show()})})}};return{init:function(a,c,d,e){b.init(a,c,d,e)}}}(jQuery,window)
