Array.prototype.all_unique=function(){"use strict";return this.filter((function(e,t,a){return a.indexOf(e)===t}))},jQuery.fn.preventDoubleSubmission=function(){return $(this).on("submit",(function(e){var t=$(this);!0===t.data("submitted")?e.preventDefault():t.data("submitted",!0)})),this};var Application=function(e,t){"use strict";var a={user_id:"",path:"",method:"POST",identifier:"",spinner:'<div class="spinner-grow" role="status"><span class="sr-only">Loading...</span></div>',data_sources:{agent:{},user:{},organization:{}},init:function(e,t,a,i){this.user_id=void 0!==e?e:"",this.method=void 0!==t?t:"POST",this.path=void 0!==a?a:"",this.identifier=void 0!==i?i:"",this.ajax_setup(),this.profile_cards(),this.bloodhound(),this.typeahead(),this.tooltips(),this.activate_dropdowns(),this.activate_radios(),this.activate_switch(),this.activate_refresh(),this.activate_popovers(),this.candidate_counter(),this.helper_navbar(),this.helper_modal()},ajax_setup:function(){var a=[];e.ajaxSetup({headers:{"X-CSRF-Token":e('meta[name="csrf-token"]').attr("content")}}),e(t).bind("beforeunload",(function(t){e.each(a,(function(e,t){t&&t.abort()}))}));e(document).ajaxSend((function(e,t,i){a.push(t)})),e(document).ajaxComplete((function(t,i,n){var o=e.inArray(i,a);a.splice(o,1)}))},profile_cards:function(){e(".card-profile").on("click",(function(a){a.stopPropagation(),t.location=e(this).find(".card-header a").attr("href")}))},bloodhound:function(){this.data_sources.agent=this.create_bloodhound("agent"),this.data_sources.agent.initialize(),this.data_sources.user=this.create_bloodhound("user"),this.data_sources.user.initialize(),this.data_sources.organization=this.create_bloodhound("organization"),this.data_sources.organization.initialize(),this.data_sources.dataset=this.create_bloodhound("dataset"),this.data_sources.dataset.initialize(),this.data_sources.taxon=this.create_bloodhound("taxon"),this.data_sources.taxon.initialize()},create_bloodhound:function(t){return new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,sufficient:10,remote:{url:"/"+t+".json?q=%QUERY",wildcard:"%QUERY",rateLimitWait:500,transform:function(a){return e.map(a,(function(e){return e.type=t,e}))}}})},typeahead:function(){var a=this,i="undefined"!=typeof Handlebars&&e("#result-template").length>0?Handlebars.compile(e("#result-template").html()):"",n="undefined"!=typeof Handlebars&&e("#empty-template").length>0?Handlebars.compile(e("#empty-template").html()):"";e("#typeahead-agent").typeahead({minLength:3,highlight:!0},{name:"agent",limit:10,source:this.data_sources.agent.ttAdapter(),display:"fullname_reverse"}).on("typeahead:select",(function(e,i){var n="undefined"!=typeof Filters?Filters.datasetKey:"",o="undefined"!=typeof Filters?Filters.taxon_id:"",r="undefined"!=typeof Filters?Filters.kingdom:"";"/admin"===a.path?t.location.href="/admin/user/"+a.identifier+"/advanced-search?agent_id="+i.id+"&datasetKey="+n+"&taxon_id="+o+"&kingdom="+r:"/agents"===a.path?t.location.href="/agent/"+i.id:"/help-others"===a.path?t.location.href="/help-others/"+a.identifier+"/advanced-search?agent_id="+i.id+"&datasetKey="+n+"&taxon_id="+o+"&kingdom="+r:t.location.href="/profile/advanced-search?agent_id="+i.id+"&datasetKey="+n+"&taxon_id="+o+"&kingdom="+r})),e("#typeahead-user").typeahead({minLength:3,highlight:!0},{name:"user",limit:10,source:this.data_sources.user.ttAdapter(),display:"fullname_reverse",templates:{suggestion:i,empty:n}}).on("typeahead:select",(function(e,i){var n=i.orcid||i.wikidata;"/admin"===a.path?t.location.href="/admin/user/"+n:"/roster"===a.path?t.location.href="/"+n:t.location.href="/help-others/"+n})),e("#typeahead-organization").typeahead({minLength:1,highlight:!0},{name:"organization",source:this.data_sources.organization.ttAdapter(),display:"name"}).on("typeahead:select",(function(e,i){"/admin"===a.path?t.location.href="/admin/organization/"+i.id:t.location.href="/organization/"+i.preferred})),e("#typeahead-dataset").typeahead({minLength:1,highlight:!0},{name:"dataset",limit:10,source:this.data_sources.dataset.ttAdapter(),display:"title"}).on("typeahead:select",(function(e,i){var n="undefined"!=typeof Filters?Filters.agent_id:"",o="undefined"!=typeof Filters?Filters.taxon_id:"",r="undefined"!=typeof Filters?Filters.kingdom:"";"/admin"!==a.path||a.identifier?"/admin"===a.path&&a.identifier?t.location.href="/admin/user/"+a.identifier+"/advanced-search?agent_id="+n+"&datasetKey="+i.datasetkey+"&taxon_id="+o+"&kingdom="+r:"/help-others"===a.path?t.location.href="/help-others/"+a.identifier+"/advanced-search?agent_id="+n+"&datasetKey="+i.datasetkey+"&taxon_id="+o+"&kingdom="+r:"/profile"===a.path?t.location.href="/profile/advanced-search?agent_id="+n+"&datasetKey="+i.datasetkey+"&taxon_id="+o+"&kingdom="+r:t.location.href="/dataset/"+i.datasetkey:t.location.href="/admin/dataset/"+i.datasetkey})),e("#typeahead-taxon").typeahead({minLength:1,highlight:!0},{name:"taxon",limit:10,source:this.data_sources.taxon.ttAdapter(),display:"name"}).on("typeahead:select",(function(e,i){var n="undefined"!=typeof Filters?Filters.agent_id:"",o="undefined"!=typeof Filters?Filters.datasetKey:"",r="undefined"!=typeof Filters?Filters.kingdom:"";"/help-others"===a.path?t.location.href="/help-others/"+a.identifier+"/advanced-search?agent_id="+n+"&datasetKey="+o+"&taxon_id="+i.id+"&kingdom="+r:"/profile"===a.path?t.location.href="/profile/advanced-search?agent_id="+n+"&datasetKey="+o+"&taxon_id="+i.id+"&kingdom="+r:"/admin"!==a.path||a.identifier?"/admin"===a.path&&a.identifier?t.location.href="/admin/user/"+a.identifier+"/advanced-search?agent_id="+n+"&datasetKey="+o+"&taxon_id="+i.id+"&kingdom="+r:"/taxa"===a.path?t.location.href="/taxon/"+i.name:t.location.href=t.location.pathname+"?q="+i.name:t.location.href="/admin/taxon/"+i.name}))},tooltips:function(){e('[data-toggle="tooltip"]').tooltip(),e('[data-toggle="tooltip"]',"nav").on("mouseenter",(function(){e(this).find("span").is(":visible")&&e(this).tooltip("hide")})).on("focus",(function(){e(this).tooltip("hide")}))},activate_dropdowns:function(){var a=this,i="",n="",o="",r="",s="";e(".form-check-label").on("click",(function(e){e.stopPropagation()})),e("a.expand-collapse").on("click",(function(t){var a=e(this).children().first();t.stopPropagation(),t.preventDefault(),a.hasClass("fa-angle-double-down")?(a.removeClass("fa-angle-double-down").addClass("fa-angle-double-up"),e(this).parent().prev().css({"max-height":"100%"})):(a.removeClass("fa-angle-double-up").addClass("fa-angle-double-down"),e(this).parent().prev().css({"max-height":"300px"}))})),e("#kingdom, #country").on("change",(function(){"undefined"!=typeof Filters&&(i=Filters.agent_id,n=Filters.datasetKey,o=Filters.taxon_id,r=Filters.kingdom,s=Filters.country_code),"country"==this.id&&(s=this.value),"kingdom"==this.id&&(r=this.value),"/help-others"===a.path?t.location.href="/help-others/"+a.identifier+"/advanced-search?agent_id="+i+"&taxon_id="+o+"&datasetKey="+n+"&kingdom="+r+"&country_code="+s:"/profile"===a.path?t.location.href="/profile/advanced-search?agent_id="+i+"&datasetKey="+n+"&taxon_id="+o+"&kingdom="+r+"&country_code="+s:"/admin"===a.path&&(t.location.href="/admin/user/"+a.identifier+"/advanced-search?agent_id="+i+"&datasetKey="+n+"&taxon_id="+o+"&kingdom="+r+"&country_code="+s)}))},activate_switch:function(){e("#toggle-public").on("change",(function(){return e.ajax({method:"PUT",url:e(this).attr("data-url"),dataType:"json",data:JSON.stringify({is_public:e(this).prop("checked")})}).done((function(e){location.reload()})),!1}))},activate_radios:function(){var a=this,i="",n="";"/profile"===a.path?i=a.path+"/candidates":"/admin"===a.path?(n=t.location.pathname.split("/")[3],i=a.path+"/user/"+n+"/candidates"):"/help-others"===a.path&&(n=t.location.pathname.split("/")[2],i=a.path+"/"+n),e("#relaxed").on("change",(function(){return i=new URL(t.location.href),e(this).prop("checked")?(i.searchParams.set("relaxed",1),t.location.href=i.href):(i.searchParams.set("relaxed",0),t.location.href=i.href),!1})),e("input.action-radio").on("change",(function(){var t=e(this).parents("tr"),i=e(this).attr("data-action"),n=e(this).parent(),o=e(this);if("selection-all"===e(this).attr("name")){var r=e.map(e("[data-occurrence-id]:not(:disabled)"),(function(t){return e(t).attr("data-occurrence-id")})).all_unique().toString();if(!r.trim())return!1;e.ajax({method:a.method,url:a.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:a.user_id,occurrence_ids:r,action:i,visible:!0}),beforeSend:function(t){e(".table label:not(:disabled)").addClass("disabled"),e(".table button:not(:disabled)").addClass("disabled")}}).done((function(t){"POST"===a.method||o.hasClass("restore-ignored")?e(".table tbody tr").fadeOut(250).promise().done((function(){e(this).remove(),e(".table tbody").append('<tr><td colspan="12">'+a.spinner+"</td></tr>"),location.reload()})):(e(".table button").removeClass("disabled"),e("label").each((function(){var t=e(this).hasClass("active");e(this).removeClass("active").removeClass("disabled"),e("input:first-child:not(:disabled)",this).attr("data-action")===i&&e(this).addClass("active"),e("input:first-child",this).prop("disabled")&&(e(this).addClass("disabled"),t&&e(this).addClass("active"))})))}))}else{var s=e(this).attr("data-occurrence-id");e.ajax({method:a.method,url:a.path+"/user-occurrence/"+s+".json",dataType:"json",data:JSON.stringify({user_id:a.user_id,action:i,visible:!0}),beforeSend:function(a){e("label",t).addClass("disabled"),e("button",t).addClass("disabled")}}).done((function(i){"POST"===a.method||o.hasClass("restore-ignored")?o.parents("tr").fadeOut(250).promise().done((function(){e(this).remove(),e("input.action-radio").length<=6&&(e(".table tbody").append('<tr><td colspan="12">'+a.spinner+"</td></tr>"),location.reload())})):(e("label",t).removeClass("active").removeClass("disabled"),n.addClass("active"),e("button",t).removeClass("disabled"))}))}return!1})),e("button.remove:not(:disabled)").on("click",(function(){var t=e(this).attr("data-occurrence-id"),i=e(this).parents("tr");return e.ajax({method:"DELETE",url:a.path+"/user-occurrence/"+t+".json",data:JSON.stringify({user_id:a.user_id}),beforeSend:function(t){e("label",i).addClass("disabled"),e("button",i).addClass("disabled")}}).done((function(t){i.fadeOut(250,(function(){i.remove(),0===e("button.remove:not(:disabled)").length&&location.reload()}))})),!1})),e("button.remove-all").on("click",(function(){var t=e.map(e("[data-occurrence-id]:not(:disabled)"),(function(t){return e(t).attr("data-occurrence-id")})).all_unique().toString();return!!t.trim()&&(e.ajax({method:"DELETE",url:a.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:a.user_id,occurrence_ids:t}),beforeSend:function(t){e(".table label").addClass("disabled"),e(".table button").addClass("disabled")}}).done((function(t){e(".table tbody tr").fadeOut(250).promise().done((function(){e(this).remove(),e(".table tbody").append('<tr><td colspan="12">'+a.spinner+"</td></tr>"),location.reload()}))})),!1)})),e("button.hide-all").on("click",(function(){var t=e.map(e("[data-occurrence-id]:not(:disabled)"),(function(t){return e(t).attr("data-occurrence-id")})).all_unique().toString();return!!t.trim()&&(e.ajax({method:a.method,url:a.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:a.user_id,occurrence_ids:t,visible:0}),beforeSend:function(t){e(".table label").addClass("disabled"),e(".table button").addClass("disabled")}}).done((function(t){e(".table tbody tr").fadeOut(250).promise().done((function(){e(this).remove(),e(".table tbody").append('<tr><td colspan="12">'+a.spinner+"</td></tr>"),location.reload()}))})),!1)})),e("button.hide:not(:disabled)").on("click",(function(){var t=e(this).attr("data-occurrence-id"),i=e(this).parents("tr");return e.ajax({method:a.method,url:a.path+"/user-occurrence/"+t+".json",dataType:"json",data:JSON.stringify({user_id:a.user_id,visible:0}),beforeSend:function(t){e("label",i).addClass("disabled"),e("button",i).addClass("disabled")}}).done((function(t){i.fadeOut(250,(function(){i.remove(),0===e("button.hide:not(:disabled)").length&&location.reload()}))})),!1})),e("button.thanks").on("click",(function(t){t.stopPropagation();var i=this,n=e(this).attr("data-recipient-identifier");e.ajax({method:"POST",url:a.path+"/message.json",dataType:"json",data:JSON.stringify({recipient_identifier:n})}).done((function(t){e(i).removeClass("btn-outline-danger").addClass("btn-outline-success").addClass("disabled").prop("disabled",!0).find("i").removeClass("fa-heart").addClass("fa-check")}))}))},activate_refresh:function(){e("a.profile-flush").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:e(this).attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){a.find("i").first().removeClass("fa-spin"),e("#flush-message").alert().show(),e("#flush-message").on("closed.bs.alert",(function(){location.reload()})),setTimeout((function(){location.reload()}),2500)})),!1})),e("a.organization-refresh").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){a.find("i").first().removeClass("fa-spin"),e("#organization-refresh").alert().show(),e("#organization-refresh").on("closed.bs.alert",(function(){location.reload()})),setTimeout((function(){location.reload()}),2500)})),!1})),e("a.codes-refresh").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){a.find("i").first().removeClass("fa-spin"),e("#organization-codes-refresh").alert().show(),e("#organization-codes-refresh").on("closed.bs.alert",(function(){location.reload()})),setTimeout((function(){location.reload()}),2500)})),!1})),e("a.dataset-refresh").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){a.find("i").first().removeClass("fa-spin"),e(".alert-gbif").alert().show(),e(".alert").on("closed.bs.alert",(function(){location.reload()})),setTimeout((function(){location.reload()}),2500)})),!1})),e("a.dataset-frictionless").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){a.find("i").first().removeClass("fa-spin"),e(".alert-frictionless").alert().show(),e(".alert").on("closed.bs.alert",(function(){location.reload()})),setTimeout((function(){location.reload()}),2500)})),!1})),e("#articles-check").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(e){location.reload()})),!1})),e("a.article-process").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){a.find("i").first().removeClass("fa-spin"),e(".alert-article-process").alert().show(),e(".alert").on("closed.bs.alert",(function(){location.reload()})),setTimeout((function(){location.reload()}),2500)})),!1})),e("a.taxon-process").on("click",(function(t){var a=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){a.find("i").first().removeClass("fa-spin"),null==t&&(e("#taxon-search-result").html("No image found."),e(".alert-taxon-process").removeClass("alert-success").addClass("alert-warning")),e(".alert-taxon-process").alert().show(),e(".alert").on("closed.bs.alert",(function(){location.reload()})),setTimeout((function(){location.reload()}),2500)})),!1})),e("a.help-refresh").on("click",(function(t){var a,i=e(this);return t.stopPropagation(),t.preventDefault(),e.ajax({method:"GET",url:i.attr("href"),beforeSend:function(e){i.addClass("disabled").find("i").first().addClass("fa-spin")}}).done((function(t){i.find("i").first().removeClass("fa-spin"),a=e.map(t,(function(e){return'<a href="/help-others/'+e.identifier+'">'+e.fullname+"</a>"})),e("#friends").html(a.join(", "))})),!1}))},activate_popovers:function(){var t=this;e.each(e('[data-toggle="popover"]'),(function(a,i){var n=this;e(this).popover({container:e(n),trigger:"hover",html:!0,content:function(){return t.gbif_images(e(n))}}).on("hide.bs.popover",(function(){if(e(".popover:hover",n).length)return!1}))}))},gbif_images:function(t){var a=this;return e.ajax({url:"/occurrence/"+e(t).attr("data-gbifid")+"/still_images.json",method:"GET",dataType:"json"}).done((function(i){e(t).find(".popover-body").html(a.carousel_template(i,e(t).attr("data-gbifid"))).find("img").each((function(){var t=e(this);a.wait_loader(t[0]).then((function(){t[0].naturalHeight>300&&t.mlens({imgSrc:t.attr("data-big"),lensShape:"square",lensSize:["100px","100px"],borderSize:0,zoomLevel:1})}))}))})),a.spinner},wait_loader:function(e){return new Promise((function(t){e.onload=t}))},carousel_template:function(t,a){var i="";return i+='<div id="carousel-indicators-'+a+'" class="carousel slide" data-ride="carousel" style="min-width:250px;min-height:100px;">',t.length>1&&(i+='<ol class="carousel-indicators">',e.each(t,(function(e,t){i+='<li data-target="#carousel-indicators-'+a+'" data-slide-to="'+e+'"'+(0===e?" class='active'":"")+"></li>"})),i+="</ol>"),i+='<div class="carousel-inner">',e.each(t,(function(e,t){i+='<div class="carousel-item'+(0===e?" active":"")+'">',i+='<a href="'+t.original+'" target="_blank"><img src="'+t.small+'" class="d-block" data-big="'+t.large+'"/></a>',i+="</div>"})),i+="</div>",t.length>1&&(i+='<a class="carousel-control-prev" href="#carousel-indicators-'+a+'" role="button" data-slide="prev">',i+='<span class="carousel-control-prev-icon" aria-hidden="true"></span>',i+='<span class="sr-only">Previous</span>',i+="</a>",i+='<a class="carousel-control-next" href="#carousel-indicators-'+a+'" role="button" data-slide="next">',i+='<span class="carousel-control-next-icon" aria-hidden="true"></span>',i+='<span class="sr-only">Next</span>',i+="</a>"),i+="</div>"},candidate_counter:function(){var t=this,a="";"/profile"===t.path?a=t.path:"/admin"===t.path&&t.identifier?a=t.path+"/user/"+t.identifier:"/help-others"===t.path&&t.identifier&&(a=t.path+"/"+t.identifier),a.length>0&&e("#specimen-counter").length&&e.ajax({method:"GET",url:a+"/candidate-count.json"}).done((function(t){t.count>0&&t.count<=50?e("#specimen-counter").text(t.count).show():t.count>50&&e("#specimen-counter").text("50+").show()}))},helper_navbar:function(){if(e("#helper-info").length&&e("#helper-navbar").length&&("/help-others"===this.path||"/admin"===this.path)){var t=e("#helper-navbar");e(document).scroll((function(){e(this).scrollTop()>e("#helper-info").offset().top?t.removeClass("d-none"):t.addClass("d-none")}))}},helper_modal:function(){var t=this,a="";e("#helperPublicModal").on("show.bs.modal",(function(i){var n=e("#helpers-list").hide().next();e("#helpers-list-none").hide(),n.empty(),e("#visibility-form").preventDoubleSubmission().submit((function(){e(this).find("button[type='submit']").prop("disabled",!0)})),e.ajax({method:"GET",url:"/help-others/"+t.identifier+"/helpers.json"}).done((function(t){t.helpers.length>0?(a=e.map(t.helpers,(function(e){var t="";return e.email&&e.email.length>0&&(t=" ("+e.email+")"),"<li>"+e.given+" "+e.family+t+"</li>"})),n.append(a.join("")).prev().show()):e("#helpers-list-none").show()}))}))}};return{init:function(e,t,i,n){a.init(e,t,i,n)}}}(jQuery,window);
