Array.prototype.all_unique=function(){"use strict";return this.filter(function(e,t,a){return a.indexOf(e)===t})},jQuery.fn.preventDoubleSubmission=function(){return $(this).on("submit",function(e){var t=$(this);!0===t.data("submitted")?e.preventDefault():t.data("submitted",!0)}),this};var Application=function(s,r){"use strict";var n={user_id:"",path:"",method:"POST",identifier:"",spinner:'<div class="spinner-grow" role="status"><span class="sr-only">Loading...</span></div>',data_sources:{agent:{},user:{},organization:{}},init:function(e,t,a,i){this.user_id=void 0!==e?e:"",this.method=void 0!==t?t:"POST",this.path=void 0!==a?a:"",this.identifier=void 0!==i?i:"",this.ajax_setup(),this.profile_cards(),this.bloodhound(),this.typeahead(),this.tooltips(),this.activate_dropdowns(),this.activate_radios(),this.activate_switch(),this.activate_refresh(),this.activate_popovers(),this.candidate_counter(),this.helper_navbar(),this.helper_modal()},ajax_setup:function(){var i=[];s.ajaxSetup({headers:{"X-CSRF-Token":s('meta[name="csrf-token"]').attr("content")}}),s(r).bind("beforeunload",function(e){s.each(i,function(e,t){t&&t.abort()})});s(document).ajaxSend(function(e,t,a){i.push(t)}),s(document).ajaxComplete(function(e,t,a){t=s.inArray(t,i);i.splice(t,1)})},profile_cards:function(){s(".card-profile").on("click",function(e){e.stopPropagation(),r.location=s(this).find(".card-header a").attr("href")})},bloodhound:function(){this.data_sources.agent=this.create_bloodhound("agent"),this.data_sources.agent.initialize(),this.data_sources.user=this.create_bloodhound("user"),this.data_sources.user.initialize(),this.data_sources.organization=this.create_bloodhound("organization"),this.data_sources.organization.initialize(),this.data_sources.dataset=this.create_bloodhound("dataset"),this.data_sources.dataset.initialize(),this.data_sources.taxon=this.create_bloodhound("taxon"),this.data_sources.taxon.initialize()},create_bloodhound:function(t){return new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,sufficient:10,remote:{url:"/"+t+".json?q=%QUERY",wildcard:"%QUERY",rateLimitWait:500,transform:function(e){return s.map(e,function(e){return e.type=t,e})}}})},typeahead:function(){var o=this,e="undefined"!=typeof Handlebars&&0<s("#result-template").length?Handlebars.compile(s("#result-template").html()):"",t="undefined"!=typeof Handlebars&&0<s("#empty-template").length?Handlebars.compile(s("#empty-template").html()):"";s("#typeahead-agent").typeahead({minLength:3,highlight:!0},{name:"agent",limit:10,source:this.data_sources.agent.ttAdapter(),display:"fullname_reverse"}).on("typeahead:select",function(e,t){var a="undefined"!=typeof Filters?Filters.datasetKey:"",i="undefined"!=typeof Filters?Filters.taxon_id:"",n="undefined"!=typeof Filters?Filters.kingdom:"";"/admin"===o.path?r.location.href="/admin/user/"+o.identifier+"/advanced-search?agent_id="+t.id+"&datasetKey="+a+"&taxon_id="+i+"&kingdom="+n:"/agents"===o.path?r.location.href="/agent/"+t.id:"/help-others"===o.path?r.location.href="/help-others/"+o.identifier+"/advanced-search?agent_id="+t.id+"&datasetKey="+a+"&taxon_id="+i+"&kingdom="+n:r.location.href="/profile/advanced-search?agent_id="+t.id+"&datasetKey="+a+"&taxon_id="+i+"&kingdom="+n}),s("#typeahead-user").typeahead({minLength:3,highlight:!0},{name:"user",limit:10,source:this.data_sources.user.ttAdapter(),display:"fullname_reverse",templates:{suggestion:e,empty:t}}).on("typeahead:select",function(e,t){t=t.orcid||t.wikidata;"/admin"===o.path?r.location.href="/admin/user/"+t:"/roster"===o.path?r.location.href="/"+t:r.location.href="/help-others/"+t}),s("#typeahead-organization").typeahead({minLength:1,highlight:!0},{name:"organization",source:this.data_sources.organization.ttAdapter(),display:"name"}).on("typeahead:select",function(e,t){"/admin"===o.path?r.location.href="/admin/organization/"+t.id:r.location.href="/organization/"+t.preferred}),s("#typeahead-dataset").typeahead({minLength:1,highlight:!0},{name:"dataset",limit:10,source:this.data_sources.dataset.ttAdapter(),display:"title"}).on("typeahead:select",function(e,t){var a="undefined"!=typeof Filters?Filters.agent_id:"",i="undefined"!=typeof Filters?Filters.taxon_id:"",n="undefined"!=typeof Filters?Filters.kingdom:"";"/admin"!==o.path||o.identifier?"/admin"===o.path&&o.identifier?r.location.href="/admin/user/"+o.identifier+"/advanced-search?agent_id="+a+"&datasetKey="+t.datasetkey+"&taxon_id="+i+"&kingdom="+n:"/help-others"===o.path?r.location.href="/help-others/"+o.identifier+"/advanced-search?agent_id="+a+"&datasetKey="+t.datasetkey+"&taxon_id="+i+"&kingdom="+n:"/profile"===o.path?r.location.href="/profile/advanced-search?agent_id="+a+"&datasetKey="+t.datasetkey+"&taxon_id="+i+"&kingdom="+n:r.location.href="/dataset/"+t.datasetkey:r.location.href="/admin/dataset/"+t.datasetkey}),s("#typeahead-taxon").typeahead({minLength:1,highlight:!0},{name:"taxon",limit:10,source:this.data_sources.taxon.ttAdapter(),display:"name"}).on("typeahead:select",function(e,t){var a="undefined"!=typeof Filters?Filters.agent_id:"",i="undefined"!=typeof Filters?Filters.datasetKey:"",n="undefined"!=typeof Filters?Filters.kingdom:"";"/help-others"===o.path?r.location.href="/help-others/"+o.identifier+"/advanced-search?agent_id="+a+"&datasetKey="+i+"&taxon_id="+t.id+"&kingdom="+n:"/profile"===o.path?r.location.href="/profile/advanced-search?agent_id="+a+"&datasetKey="+i+"&taxon_id="+t.id+"&kingdom="+n:"/admin"!==o.path||o.identifier?"/admin"===o.path&&o.identifier?r.location.href="/admin/user/"+o.identifier+"/advanced-search?agent_id="+a+"&datasetKey="+i+"&taxon_id="+t.id+"&kingdom="+n:"/taxa"===o.path?r.location.href="/taxon/"+t.name:r.location.href=r.location.pathname+"?q="+t.name:r.location.href="/admin/taxon/"+t.name})},tooltips:function(){s('[data-toggle="tooltip"]').tooltip(),s('[data-toggle="tooltip"]',"nav").on("mouseenter",function(){s(this).find("span").is(":visible")&&s(this).tooltip("hide")}).on("focus",function(){s(this).tooltip("hide")})},activate_dropdowns:function(){var e=this,t="",a="",i="",n="",o="";s("a.expand-collapse").on("click",function(e){var t=s(this).children().first();e.stopPropagation(),e.preventDefault(),t.hasClass("fa-angle-double-down")?(t.removeClass("fa-angle-double-down").addClass("fa-angle-double-up"),s(this).parent().prev().css({"max-height":"100%"})):(t.removeClass("fa-angle-double-up").addClass("fa-angle-double-down"),s(this).parent().prev().css({"max-height":"300px"}))}),s("#kingdom, #country").on("change",function(){"undefined"!=typeof Filters&&(t=Filters.agent_id,a=Filters.datasetKey,i=Filters.taxon_id,n=Filters.kingdom,o=Filters.country_code),"country"==this.id&&(o=this.value),"kingdom"==this.id&&(n=this.value),"/help-others"===e.path?r.location.href="/help-others/"+e.identifier+"/advanced-search?agent_id="+t+"&taxon_id="+i+"&datasetKey="+a+"&kingdom="+n+"&country_code="+o:"/profile"===e.path?r.location.href="/profile/advanced-search?agent_id="+t+"&datasetKey="+a+"&taxon_id="+i+"&kingdom="+n+"&country_code="+o:"/admin"===e.path&&(r.location.href="/admin/user/"+e.identifier+"/advanced-search?agent_id="+t+"&datasetKey="+a+"&taxon_id="+i+"&kingdom="+n+"&country_code="+o)})},activate_switch:function(){s("#toggle-public").on("change",function(){return s.ajax({method:"PUT",url:s(this).attr("data-url"),dataType:"json",data:JSON.stringify({is_public:s(this).prop("checked")})}).done(function(e){location.reload()}),!1})},activate_radios:function(){var o=this,e="",t="";"/profile"===o.path?e=o.path+"/candidates":"/admin"===o.path?(t=r.location.pathname.split("/")[3],e=o.path+"/user/"+t+"/candidates"):"/help-others"===o.path&&(t=r.location.pathname.split("/")[2],e=o.path+"/"+t),s("#relaxed").on("change",function(){return e=new URL(r.location.href),s(this).prop("checked")?e.searchParams.set("relaxed",1):e.searchParams.set("relaxed",0),r.location.href=e.href,!1}),s("input.action-radio").on("change",function(){var t=s(this).parents("tr"),a=s(this).attr("data-action"),i=s(this).parent(),n=s(this);if("selection-all"===s(this).attr("name")){var e=s.map(s("[data-occurrence-id]:not(:disabled)"),function(e){return s(e).attr("data-occurrence-id")}).all_unique().toString();if(!e.trim())return!1;s.ajax({method:o.method,url:o.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:o.user_id,occurrence_ids:e,action:a,visible:!0}),beforeSend:function(e){s(".table label:not(:disabled)").addClass("disabled"),s(".table button:not(:disabled)").addClass("disabled")}}).done(function(e){"POST"===o.method||n.hasClass("restore-ignored")?s(".table tbody tr").fadeOut(250).promise().done(function(){s(this).remove(),s(".table tbody").append('<tr><td colspan="12">'+o.spinner+"</td></tr>"),location.reload()}):(s(".table button").removeClass("disabled"),s("label").each(function(){var e=s(this).hasClass("active");s(this).removeClass("active").removeClass("disabled"),s("input:first-child:not(:disabled)",this).attr("data-action")===a&&s(this).addClass("active"),s("input:first-child",this).prop("disabled")&&(s(this).addClass("disabled"),e&&s(this).addClass("active"))}))})}else{e=s(this).attr("data-occurrence-id");s.ajax({method:o.method,url:o.path+"/user-occurrence/"+e+".json",dataType:"json",data:JSON.stringify({user_id:o.user_id,action:a,visible:!0}),beforeSend:function(e){s("label",t).addClass("disabled"),s("button",t).addClass("disabled")}}).done(function(e){"POST"===o.method||n.hasClass("restore-ignored")?n.parents("tr").fadeOut(250).promise().done(function(){s(this).remove(),s("input.action-radio").length<=6&&(s(".table tbody").append('<tr><td colspan="12">'+o.spinner+"</td></tr>"),location.reload())}):(s("label",t).removeClass("active").removeClass("disabled"),i.addClass("active"),s("button",t).removeClass("disabled"))})}return!1}),s("button.remove:not(:disabled)").on("click",function(){var e=s(this).attr("data-occurrence-id"),t=s(this).parents("tr");return s.ajax({method:"DELETE",url:o.path+"/user-occurrence/"+e+".json",data:JSON.stringify({user_id:o.user_id}),beforeSend:function(e){s("label",t).addClass("disabled"),s("button",t).addClass("disabled")}}).done(function(e){t.fadeOut(250,function(){t.remove(),0===s("button.remove:not(:disabled)").length&&location.reload()})}),!1}),s("button.remove-all").on("click",function(){var e=s.map(s("[data-occurrence-id]:not(:disabled)"),function(e){return s(e).attr("data-occurrence-id")}).all_unique().toString();return e.trim()&&s.ajax({method:"DELETE",url:o.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:o.user_id,occurrence_ids:e}),beforeSend:function(e){s(".table label").addClass("disabled"),s(".table button").addClass("disabled")}}).done(function(e){s(".table tbody tr").fadeOut(250).promise().done(function(){s(this).remove(),s(".table tbody").append('<tr><td colspan="12">'+o.spinner+"</td></tr>"),location.reload()})}),!1}),s("button.hide-all").on("click",function(){var e=s.map(s("[data-occurrence-id]:not(:disabled)"),function(e){return s(e).attr("data-occurrence-id")}).all_unique().toString();return e.trim()&&s.ajax({method:o.method,url:o.path+"/user-occurrence/bulk.json",dataType:"json",data:JSON.stringify({user_id:o.user_id,occurrence_ids:e,visible:0}),beforeSend:function(e){s(".table label").addClass("disabled"),s(".table button").addClass("disabled")}}).done(function(e){s(".table tbody tr").fadeOut(250).promise().done(function(){s(this).remove(),s(".table tbody").append('<tr><td colspan="12">'+o.spinner+"</td></tr>"),location.reload()})}),!1}),s("button.hide:not(:disabled)").on("click",function(){var e=s(this).attr("data-occurrence-id"),t=s(this).parents("tr");return s.ajax({method:o.method,url:o.path+"/user-occurrence/"+e+".json",dataType:"json",data:JSON.stringify({user_id:o.user_id,visible:0}),beforeSend:function(e){s("label",t).addClass("disabled"),s("button",t).addClass("disabled")}}).done(function(e){t.fadeOut(250,function(){t.remove(),0===s("button.hide:not(:disabled)").length&&location.reload()})}),!1}),s("button.thanks").on("click",function(e){e.stopPropagation();var t=this,e=s(this).attr("data-recipient-identifier");s.ajax({method:"POST",url:o.path+"/message.json",dataType:"json",data:JSON.stringify({recipient_identifier:e})}).done(function(e){s(t).removeClass("btn-outline-danger").addClass("btn-outline-success").addClass("disabled").prop("disabled",!0).find("i").removeClass("fa-heart").addClass("fa-check")})})},activate_refresh:function(){s("a.profile-flush").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:s(this).attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){t.find("i").first().removeClass("fa-spin"),s("#flush-message").alert().show(),s("#flush-message").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),s("a.organization-refresh").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:t.attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){t.find("i").first().removeClass("fa-spin"),s("#organization-refresh").alert().show(),s("#organization-refresh").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),s("a.codes-refresh").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:t.attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){t.find("i").first().removeClass("fa-spin"),s("#organization-codes-refresh").alert().show(),s("#organization-codes-refresh").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),s("a.dataset-refresh").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:t.attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){t.find("i").first().removeClass("fa-spin"),s(".alert-gbif").alert().show(),s(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),s("a.dataset-frictionless").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:t.attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){t.find("i").first().removeClass("fa-spin"),s(".alert-frictionless").alert().show(),s(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),s("#articles-check").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:t.attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){location.reload()}),!1}),s("a.article-process").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:t.attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){t.find("i").first().removeClass("fa-spin"),s(".alert-article-process").alert().show(),s(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),s("a.taxon-process").on("click",function(e){var t=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:t.attr("href"),beforeSend:function(e){t.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){t.find("i").first().removeClass("fa-spin"),null==e&&(s("#taxon-search-result").html("No image found."),s(".alert-taxon-process").removeClass("alert-success").addClass("alert-warning")),s(".alert-taxon-process").alert().show(),s(".alert").on("closed.bs.alert",function(){location.reload()}),setTimeout(function(){location.reload()},2500)}),!1}),s("a.help-refresh").on("click",function(e){var t,a=s(this);return e.stopPropagation(),e.preventDefault(),s.ajax({method:"GET",url:a.attr("href"),beforeSend:function(e){a.addClass("disabled").find("i").first().addClass("fa-spin")}}).done(function(e){a.find("i").first().removeClass("fa-spin"),t=s.map(e,function(e){return'<a href="/help-others/'+e.identifier+'">'+e.fullname+"</a>"}),s("#friends").html(t.join(", "))}),!1})},activate_popovers:function(){var i=this;s.each(s('[data-toggle="popover"]'),function(e,t){var a=this;s(this).popover({container:s(a),trigger:"hover",html:!0,content:function(){return i.gbif_images(s(a))}}).on("hide.bs.popover",function(){if(s(".popover:hover",a).length)return!1})})},gbif_images:function(t){var a=this;return s.ajax({url:"/occurrence/"+s(t).attr("data-gbifid")+"/still_images.json",method:"GET",dataType:"json"}).done(function(e){s(t).find(".popover-body").html(a.carousel_template(e,s(t).attr("data-gbifid"))).find("img").each(function(){var e=s(this);a.wait_loader(e[0]).then(function(){300<e[0].naturalHeight&&e.mlens({imgSrc:e.attr("data-big"),lensShape:"square",lensSize:["100px","100px"],borderSize:0,zoomLevel:1})})})}),a.spinner},wait_loader:function(t){return new Promise(function(e){t.onload=e})},carousel_template:function(e,a){var i="";return i+='<div id="carousel-indicators-'+a+'" class="carousel slide" data-ride="carousel" style="min-width:250px;min-height:100px;">',1<e.length&&(i+='<ol class="carousel-indicators">',s.each(e,function(e,t){i+='<li data-target="#carousel-indicators-'+a+'" data-slide-to="'+e+'"'+(0===e?" class='active'":"")+"></li>"}),i+="</ol>"),i+='<div class="carousel-inner">',s.each(e,function(e,t){i+='<div class="carousel-item'+(0===e?" active":"")+'">',i+='<a href="'+t.original+'" target="_blank"><img src="'+t.small+'" class="d-block" data-big="'+t.large+'"/></a>',i+="</div>"}),i+="</div>",1<e.length&&(i+='<a class="carousel-control-prev" href="#carousel-indicators-'+a+'" role="button" data-slide="prev">',i+='<span class="carousel-control-prev-icon" aria-hidden="true"></span>',i+='<span class="sr-only">Previous</span>',i+="</a>",i+='<a class="carousel-control-next" href="#carousel-indicators-'+a+'" role="button" data-slide="next">',i+='<span class="carousel-control-next-icon" aria-hidden="true"></span>',i+='<span class="sr-only">Next</span>',i+="</a>"),i+="</div>"},candidate_counter:function(){var e=this,t="";"/profile"===e.path?t=e.path:"/admin"===e.path&&e.identifier?t=e.path+"/user/"+e.identifier:"/help-others"===e.path&&e.identifier&&(t=e.path+"/"+e.identifier),0<t.length&&s("#specimen-counter").length&&s.ajax({method:"GET",url:t+"/candidate-count.json"}).done(function(e){0<e.count&&e.count<=50?s("#specimen-counter").text(e.count).show():50<e.count&&s("#specimen-counter").text("50+").show()})},helper_navbar:function(){var e;s("#helper-info").length&&s("#helper-navbar").length&&("/help-others"!==this.path&&"/admin"!==this.path||(e=s("#helper-navbar"),s(document).scroll(function(){s(this).scrollTop()>s("#helper-info").offset().top?e.removeClass("d-none"):e.addClass("d-none")})))},helper_modal:function(){var a=this,i="";s("#helperPublicModal").on("show.bs.modal",function(e){var t=s("#helpers-list").hide().next();s("#helpers-list-none").hide(),t.empty(),s("#visibility-form").preventDoubleSubmission().submit(function(){s(this).find("button[type='submit']").prop("disabled",!0)}),s.ajax({method:"GET",url:"/help-others/"+a.identifier+"/helpers.json"}).done(function(e){0<e.helpers.length?(i=s.map(e.helpers,function(e){var t="";return e.email&&0<e.email.length&&(t=" ("+e.email+")"),"<li>"+e.given+" "+e.family+t+"</li>"}),t.append(i.join("")).prev().show()):s("#helpers-list-none").show()})})}};return{init:function(e,t,a,i){n.init(e,t,a,i)}}}(jQuery,window);
